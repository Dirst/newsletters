# Установка

Запустите docker compose up -d

# Управление
Чтобы добавить воркеров вызовите команду:

`docker compose up -d --scale sender=30`

В сервисе scheduler работает крон настроенный на запуск в полночь ежедневно. (UTC +0)

# Тест
Можно протестировать работу воркеров:
- добавьте 10000 юзеров `docker compose exec scheduler php test.php`
- вызвите scheduler `docker compose exec scheduler php schedule.php`
- Смотрите как уменьшается количество записей (начнется через 5 секунд после заполнения очереди).
`docker compose exec db mysql -uroot -prootroot -e "SELECT count(*) FROM app.send_queue;"`

# Пояснение
условия:
- 80% - без подписок
- 15% - подтвержденных
- send_email исполняется (1+10)/2 = 5.5 сек - мат. ожидание при большом количестве вызовов при равномерном распределении.
- check_email - стоимость 1 руб. и мат ожидание 30.5 сек.

Confirmed и подписка гарантируют, что email валидный, тогда количество пользователей, которым надо отправлять письма:
> Таблица 5млн+ записей, значит всего юзеров которым надо отправить email ~ 0.2x0.15x(5млн) ~ 150к.

В крайнем не возможном сценарии если все юзеры приобрели подписку в один день, то надо будет отправлять все 150к писем за сессию.
> 150k писем по 5.5 сек = 229 часов. Если взять рабочий день 8 часов, то нужно 29 воркеров.

В более реальном сценарии:
> Если нужно еще сэкономить на воркерах, тогда нужно проверить таблицу - какое максимальное количество пользователей имеют окончание подписки в один день и оттолкнуться от этого.

Функция `check_email`(очень дорогая) используется вероятно для других целей, но т.к. было обозначено выше, что
пользователь с подтвержденным email и подпиской уже имеет валидный емайл, для целей рассылки уведомлений ее вызывать не требуется.
